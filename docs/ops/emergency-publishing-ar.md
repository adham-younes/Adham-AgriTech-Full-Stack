# خطة النشر الطارئة

هذه الخطة تختصر الخطوات الحرجة لإعادة النشر فورًا عندما تتعطل خطوط CI/CD أو يفشل الربط مع المستودع أو Vercel. الهدف هو إزالة العوائق بأسرع ما يمكن وإعادة الموقع إلى حالة مستقرة بدون اللجوء إلى تغييرات معقدة.

## 1. تجهيز الأسرار والربط

1. انسخ الملف `.env.publish.example` إلى `.env.publish` واملأ القيم التالية:
   - `VERCEL_TOKEN` – رمز وصول يمتلك صلاحية **deploy** أو **manage** للمشروع.
   - `VERCEL_PROJECT_ID` أو `VERCEL_PROJECT` – معرّف المشروع أو اسمه داخل Vercel.
   - (اختياري) `VERCEL_TEAM_ID` إذا كان المشروع تحت فريق.
   - (اختياري لكن مهم) `GIT_REMOTE_URL` مع عنوان HTTPS يحتوي على رمز الوصول أو الـPAT حتى يتمكن السكربت من إضافة الريموت ودفع الفروع.

2. إذا كنت تحتاج لتمرير فرع محدد أو اسم ريموت مختلف، أضف `GIT_BRANCH` و`GIT_REMOTE_NAME`. وللدفع الأول لفرع جديد، اجعل `GIT_SET_UPSTREAM=true`.

## 2. تشغيل مزامنة المستودع والنشر

نفّذ الأمر التالي من جذر المشروع:

```bash
pnpm vercel:emergency --skip-build
```

ما الذي يحدث؟

- **مزامنة Git**: إذا تم ضبط `GIT_REMOTE_URL` سيقوم السكربت بإضافة الريموت (أو تحديثه) ثم دفع الفرع الحالي. استخدم `--no-sync` لتخطي هذه الخطوة أو `--sync-only` إذا كنت تريد التحقق من المزامنة دون النشر.
- **فحص الجاهزية**: يتم تشغيل `pnpm vercel:check` تلقائيًا داخل نفس السياق البيئي للتأكد من وجود الرموز والمعرّفات اللازمة. أي فشل يوقف العملية لتجنب نشر غير مكتمل.
- **نشر مباشر**: يتم استدعاء سكربت `vercel-direct-deploy` مع تمرير خيارات مثل `--skip-build` أو `--no-prebuilt` إذا تم تحديدها، كما يمكن تمرير قيم `VERCEL_DEPLOY_META_KEY` و`VERCEL_DEPLOY_META_VALUE` من ملف البيئة لإرفاق بيانات تعريفية.

### مفاتيح إضافية

- `--dry-run`: يعرض الأوامر التي سيتم تنفيذها دون القيام بأي تغييرات فعلية، ويمكن تشغيله حتى بدون ضبط
  `VERCEL_TOKEN` أو ربط المستودع لعرض ما ينقصك قبل التنفيذ الحقيقي.
- `--deploy-only`: يتخطى خطوة مزامنة Git (يفيد عندما تم الدفع يدويًا لكن نحتاج فقط إلى إعادة النشر).
- `--no-prebuilt`: يرسل ملفات البناء بدون خيار `--prebuilt` في حال أردت أن تنفذ Vercel البناء من الصفر.

## 3. التحقق بعد التنفيذ

بعد النجاح، استخدم إحدى الطرق التالية للتأكد من أن النطاق أصبح على آخر نسخة:

- تشغيل `pnpm vercel:status --prod --wait 120` مع نفس متغيرات البيئة للتحقق من حالة آخر نشر.
- زيارة صفحة [غرفة التحكم في النشر](/ops/deployments) داخل المنصة لمراقبة التايملاين والرسوم البيانية المباشرة.

## 4. خطة الاستعادة السريعة

إذا فشل النشر الطارئ:

1. تأكد من صحة `VERCEL_TOKEN` وصلاحيته. قم بتجديده من لوحة Vercel إذا لزم الأمر.
2. تحقّق من أن المشروع مرتبط بالحساب الصحيح (`VERCEL_PROJECT_ID` + `VERCEL_TEAM_ID`).
3. راجع سجل الأوامر لمعرفة الخطوة التي توقفت، ثم شغّل السكربت مع `--dry-run` لمراجعة الأوامر بدون تنفيذ.
4. احتفظ بملف `.env.publish` مشفّرًا داخل مدير أسرار الفريق لضمان إمكانية الوصول السريع أثناء الأعطال.

باستخدام هذه الخطة يصبح لديك مسار طارئ موحّد يعيد تشغيل النشر خلال دقائق بدلًا من ساعات من التشخيص اليدوي، ويحافظ على استقرار المنصة حتى أثناء تعطل خطوط النشر الآلية.
