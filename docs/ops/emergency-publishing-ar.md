# خطة النشر الطارئة

هذه الخطة تختصر الخطوات الحرجة لإعادة النشر فورًا عندما تتعطل خطوط CI/CD أو يفشل الربط مع المستودع أو Vercel. الهدف هو إزالة العوائق بأسرع ما يمكن وإعادة الموقع إلى حالة مستقرة بدون اللجوء إلى تغييرات معقدة.

## 1. تجهيز الأسرار والربط

> **تذكير أمني:** لا تشارك رموز الوصول أو كلمات المرور داخل المستودع. احتفظ بها في متغيرات البيئة أو في مدير أسرار الفريق فقط.

1. انسخ الملف `.env.publish.example` إلى `.env.publish` واملأ القيم التالية:
   - `VERCEL_TOKEN` – رمز وصول يمتلك صلاحية **deploy** أو **manage** للمشروع. يمكن إصدار الرمز من لوحة التحكم باتباع دليل [Vercel CLI](https://vercel.com/docs/cli#authentication) أو أوامر `vercel login`.
   - `VERCEL_PROJECT_ID` أو `VERCEL_PROJECT` – معرّف المشروع أو اسمه داخل Vercel. ستجده في صفحة إعدادات المشروع أو من خلال ملف `.vercel/project.json` بعد تشغيل `vercel link` كما هو موضح في [وثائق ربط المشروع](https://vercel.com/docs/cli/link).
   - (اختياري) `VERCEL_TEAM_ID` إذا كان المشروع تحت فريق. يمكن نسخه من صفحة الفريق في Vercel أو من إعدادات المشروع.
   - (اختياري عند الحاجة) `VERCEL_PROTECTION_BYPASS_SECRET` – السر الخاص بتجاوز حماية النشر التلقائي. استخدم القيمة المنشأة من إعدادات "Deployment Protection" داخل Vercel، واحفظها في متغير بيئة فقط.
   - (اختياري لكن مهم) `GIT_REMOTE_URL` مع عنوان HTTPS يحتوي على رمز الوصول أو الـPAT حتى يتمكن السكربت من إضافة الريموت ودفع الفروع، أو يمكنك إعداد الريموت يدويًا بالأمر `git remote add origin <url>` ثم استخدام `git push`.

2. إذا كنت تحتاج لتمرير فرع محدد أو اسم ريموت مختلف، أضف `GIT_BRANCH` و`GIT_REMOTE_NAME`. وللدفع الأول لفرع جديد، اجعل `GIT_SET_UPSTREAM=true` (أو استخدم `git push -u origin <branch>` مرة واحدة يدويًا).

3. تأكد من وجود متغيرات البيئة التي يعتمد عليها التطبيق (مفاتيح قواعد البيانات، خدمات الطرف الثالث، ...إلخ) داخل إعدادات Vercel باتباع [دليل متغيرات البيئة](https://vercel.com/docs/projects/environment-variables). إذا كانت القيم موجودة في `.env` محليًا فيجب رفعها يدويًا إلى Vercel.

## 2. تشغيل مزامنة المستودع والنشر

نفّذ الأمر التالي من جذر المشروع:

```bash
pnpm vercel:emergency --skip-build
```

ما الذي يحدث؟

- **مزامنة Git**: إذا تم ضبط `GIT_REMOTE_URL` سيقوم السكربت بإضافة الريموت (أو تحديثه) ثم دفع الفرع الحالي. استخدم `--no-sync` لتخطي هذه الخطوة أو `--sync-only` إذا كنت تريد التحقق من المزامنة دون النشر.
- **فحص الجاهزية**: يتم تشغيل `pnpm vercel:check` تلقائيًا داخل نفس السياق البيئي للتأكد من وجود الرموز والمعرّفات اللازمة. أي فشل يوقف العملية لتجنب نشر غير مكتمل.
- **نشر مباشر**: يتم استدعاء سكربت `vercel-direct-deploy` مع تمرير خيارات مثل `--skip-build` أو `--no-prebuilt` إذا تم تحديدها، كما يمكن تمرير قيم `VERCEL_DEPLOY_META_KEY` و`VERCEL_DEPLOY_META_VALUE` من ملف البيئة لإرفاق بيانات تعريفية.

### خطوات سريعة في حال أردت التنفيذ يدويًا

1. **رابط المشروع**
   ```bash
   vercel link
   ```
   اتبع التعليمات التفاعلية لاختيار الفريق والمشروع المناسبين.

2. **سحب إعدادات البيئة من Vercel**
   ```bash
   vercel pull --yes
   ```
   هذا يضمن تطابق القيم المحلية مع ما هو موجود في الإنتاج.

3. **تشغيل بناء اختباري (اختياري لكن موصى به)**
   ```bash
   pnpm build
   ```

4. **النشر اليدوي**
   ```bash
   vercel deploy --prebuilt --prod
   ```
   أضف `--token $VERCEL_TOKEN` إذا كنت تعمل في بيئة غير تفاعلية.

### مفاتيح إضافية

- `--dry-run`: يعرض الأوامر التي سيتم تنفيذها دون القيام بأي تغييرات فعلية، ويمكن تشغيله حتى بدون ضبط
  `VERCEL_TOKEN` أو ربط المستودع لعرض ما ينقصك قبل التنفيذ الحقيقي.
- `--deploy-only`: يتخطى خطوة مزامنة Git (يفيد عندما تم الدفع يدويًا لكن نحتاج فقط إلى إعادة النشر).
- `--no-prebuilt`: يرسل ملفات البناء بدون خيار `--prebuilt` في حال أردت أن تنفذ Vercel البناء من الصفر.

## 3. التحقق بعد التنفيذ

بعد النجاح، استخدم إحدى الطرق التالية للتأكد من أن النطاق أصبح على آخر نسخة:

- تشغيل `pnpm vercel:status --prod --wait 120` مع نفس متغيرات البيئة للتحقق من حالة آخر نشر.
- عند اختبار نطاق محمي، مرر الرأس `x-vercel-protection-bypass` باستخدام السر المحفوظ في `VERCEL_PROTECTION_BYPASS_SECRET` لضمان الوصول أثناء الفحص.
- زيارة صفحة [غرفة التحكم في النشر](/ops/deployments) داخل المنصة لمراقبة التايملاين والرسوم البيانية المباشرة.
- مراجعة لوحة مراقبة Vercel الرسمية من خلال [صفحة Deployments](https://vercel.com/dashboard) للتأكد من نجاح البناء وعدم وجود أخطاء.

## 4. خطة الاستعادة السريعة

إذا فشل النشر الطارئ:

1. تأكد من صحة `VERCEL_TOKEN` وصلاحيته. قم بتجديده من لوحة Vercel إذا لزم الأمر.
2. تحقّق من أن المشروع مرتبط بالحساب الصحيح (`VERCEL_PROJECT_ID` + `VERCEL_TEAM_ID`).
3. راجع سجل الأوامر لمعرفة الخطوة التي توقفت، ثم شغّل السكربت مع `--dry-run` لمراجعة الأوامر بدون تنفيذ.
4. احتفظ بملف `.env.publish` مشفّرًا داخل مدير أسرار الفريق لضمان إمكانية الوصول السريع أثناء الأعطال.
5. في حال تطلّب الأمر تخطي حماية النشر، استخدم سر `x-vercel-protection-bypass` المكوّن في إعدادات المشروع كما توضح وثائق [حماية النشر](https://vercel.com/docs/security/deployment-protection#deployment-protection-bypass). لا تقم بتضمينه في المستودع؛ مرّره فقط عبر متغيرات البيئة وقت الحاجة.

باستخدام هذه الخطة يصبح لديك مسار طارئ موحّد يعيد تشغيل النشر خلال دقائق بدلًا من ساعات من التشخيص اليدوي، ويحافظ على استقرار المنصة حتى أثناء تعطل خطوط النشر الآلية.
